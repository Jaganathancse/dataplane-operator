# Deploying an OpenStackDataPlaneNodeSet with Internal TLS Enabled

When an OpenStackDataPlaneNodeSet is deployed with TLS Enabled, communications
between dataplane services and with control plane services can be encrypted using
TLS connections.
`
Functionality has been added to the dataplane-operator to generate the needed
certificates for all compute nodes in the nodeset.  The details on how to enable
this functionality and how dataplane services (including custom services) can take
advantage of this functionality is provided here.

## Prerequisites

Certificates for dataplane services are generated by certmanager issuers, which are
referenced in the OpenStackDataplaneService attributes below.  These issuers must be
created beforehand.

In addition, OpenStackDataplaneService contains an attribute that allows the deployer
to specify a secret containing a TLS CA bundle.  This secret should also be created
beforehand.

## Basic deloyment steps

1. Create the issuers and cacert bundle secrets as described in the pre-requisites above.
   These were likely created as part of the control plane deployment. 
   (TODO - link to issuer/cacert docs when available)

2. Enable TLS on the OpenStackDataPlaneNodeSet and create the nodeset.  Ensure that the
   install-certs or similar service (described below) is in the list of services before
   any services that require certs (ie. that have tlsCertsEnabled set to True)

3. Deploy the OpenStackDataPlane.  Certs should be created and copied to the compute nodes
   in the nodeset.
 
## Enabling TLS on an OpenStackDataPlaneNodeSet

The OpenstackDataPlaneNodeSet has an attribute tlsEnabled, which defaults to false.
The certficate generation code will be executed only if this attribute is set to true.

## OpenStackDataplaneService attributes

### tlsCertsEnabled
Not all dataplane services will require TLS certificates.  For example, dataplane services
that install the OS or download caches do not need TLS certificates.

The attribute tlsCertsEnabled (which defaults to False) has been added to OpenStackDataplaneService.
As support is needed for tls certificates, services should set the tlsCertsEnabled attribute to True.
If this attribute is changed for an existing service, this service may need to be deleted and recreated.

When this attribute is set to True, certificates will be generated for the service during the
reconciliation loop of the dataplane-operator as described below.

### issuers
This attribute is a map of strings that corresponds to certmanager issuers that are used to issue
certificates for the dataplane service.  The use of a map allows the deployer to specify multiple
issuers in case multiple certificates are needed.   The string value is the identifier for the
certmanager issuer.   It is expected that all needed issuers will be created in the same
namespace (default: openstack) beforehand.

If the issuers attribute is not set, certificates will be issued using the default root CA for
internal TLS as defined in lib-common.

### cacerts
This attribute is a string pointing to the secret containing the TLS CA certificate bundle to be
mounted for the dataplane service.  If this is not specified, this defaults to CABundleLabel -
as defined in lib-common, which is the default TLS CA bundle for internal TLS.  This secret
is expected to be created in the same namespace (default: openstack) beforehand.

### addCertMounts
This attribute specifies whether or not to mount the certificates and keys generated for all
dataplane services (for all nodes in the nodeset) in the ansible EE pod for the service.
This attribute defaults to false.

The current design has a special dataplane service "install-certs" that is expected to run before
any services that need certificates, and which has this attribute set to true.  The purpose of this
dataplane service is to copy the certs to the correct place on the compute nodes.  This dataplane
service is described in more detail below.

## The gritty details

### How the certificates are generated

When tlsEnabled is set to True on the nodeset, and tlsCertsEnabled is enabled for the dataplane
service, certificates will be requested from the issuer designated in issuers (or the default internal
TLS CA).

The contents of the certificate (subject name, subject alternative names, etc.) is currently defined
in code [here](https://github.com/openstack-k8s-operators/dataplane-operator/blob/main/pkg/deployment/cert.go#L70).
This code is expected to be refactored soon, in favor of specifying the  contents in the OpenStackDataplaneService
attributes instead of specifying it in code here.  Therefore, we will defer documenting this behavior till then.

The default certificate contents though will provide a certificate that adds the hostnames for all the
networks on the compute node to the subject alternative names.

The certficates are generated when an OpenstackDataplaneDeployment is created, but before any ansible EE
pods are created.

When the certificates are created, certmanager stores the certificates in secrets which are named
"cert-<service_name>-<node_name>".  Each secret contains the certificate, key and cacert.

The certificates for all the nodes in the nodeset for a given service are all collected in a secret named
"<nodeset>-<service_name>-certs".  This secret is the one that is mounted in the ansibleEE when
when addCertMounts is enabled.  The code here is also slated to be refactored soon to ensure that we are
able to accomodate large deployments.

### How the certificates are transferred to the compute nodes

A dataplane service ("install-certs") has been added to added to copy over the certificates to the
compute nodes.  As noted above, this service has the addCertMounts attribute set to True.  It is expected
that this service will be executed before any other services that require TLS certs.

The service:
- Mounts the <nodeset>-<service_name>-certs secrets for all services that have tlsCertsEnabled set to true.
- Calls the osp.edpm.install_certs role which - for each node - copies all the certificates and keys for that
  node to /var/lib/openstack/certs/<service_name>.  The ca cert bundles are copied to 
  /var/lib/openstack/cacerts/<service_name>

Code should then be added to each service's ansible role to use the certs as needed.  For example, in
libvirt's role, we move the certs and keys to standard locations on the compute host.  Other roles may
mount the certs and keys into their containers using kolla or otherwise.  The certs and keys for all the
services are available as needed for all services.

### How to enable cert generation for your dataplane service

Based on the above description, the steps are pretty straightforward.

1. Set tlsCertsEnabled to true for your dataplane service.
2. Decide which issuers and cacerts you plan to use, and add them to your deployment.  You can also
   skip this to take the defaults internal TLS CA and cert bundles.
3. Decide what needs to be in the cert.  This is described in the sections above.  The default
   (if you define nothing) is to have a certs with dnsNames for all the interfaces in the SAN
   (subject alternative names)  Add arttributes as needed.
4. Modify your role to do something with the generated certs.  Read the section above to see where
   the install-certs dataplane service puts the certs.
