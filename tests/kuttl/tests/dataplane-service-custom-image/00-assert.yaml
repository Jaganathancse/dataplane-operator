---
apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneNodeSet
metadata:
  labels:
    openstackdataplane: openstack-edpm
  name: edpm-compute
spec:
  deployStrategy:
    deploy: false
  dataPlane: openstack-edpm-ipam
  services:
    - configure-network
    - validate-network
    - install-os
    - configure-os
    - run-os
  nodeTemplate:
    nodes:
      edpm-compute-0:
        ansible:
          ansibleHost: 172.20.12.67
          ansibleSSHPrivateKeySecret: dataplane-ansible-ssh-private-key-secret
          ansibleUser: root
          ansibleVars:
            ansible_ssh_transfer_method: scp
            ctlplane_ip: 172.20.12.67
            external_ip: 172.20.12.76
            fqdn_internal_api: edpm-compute-1.example.com
            internal_api_ip: 172.17.0.101
            storage_ip: 172.18.0.101
            tenant_ip: 172.10.0.101
        hostName: edpm-compute-0
        networkConfig: {}
        nova:
          cellName: cell1
          deploy: true
          novaInstance: nova
    networkConfig:
      template: |
        ---
        network_config:
        - type: interface
          name: nic2
          mtu: 1500
          addresses:
            - ip_netmask:
                {{ ctlplane_ip }}/{{ ctlplane_subnet_cidr }}
        - type: ovs_bridge
          name: {{ neutron_physical_bridge_name }}
          mtu: 1500
          use_dhcp: false
          dns_servers: {{ ctlplane_dns_nameservers }}
          domain: []
          addresses:
          - ip_netmask: {{ lookup('vars', networks_lower["External"] ~ '_ip') }}/{{ lookup('vars', networks_lower["External"] ~ '_cidr') }}
          routes: [{'ip_netmask': '0.0.0.0/0', 'next_hop': '192.168.1.254'}]
          members:
          - type: interface
            name: nic1
            mtu: 1500
            # force the MAC address of the bridge to this interface
            primary: true
          - type: vlan
            mtu: 1500
            vlan_id: 20
            addresses:
            - ip_netmask:
                172.17.0.101/24
            routes: []
          - type: vlan
            mtu: 1500
            vlan_id: 25
            addresses:
            - ip_netmask:
                172.18.0.101/24
            routes: []
          - type: vlan
            mtu: 1500
            vlan_id: 22
            addresses:
            - ip_netmask:
                172.19.0.101/24
            routes: []
    managed: false
    managementNetwork: ctlplane
    ansible:
      ansibleUser: root
      ansiblePort: 22
status:
  conditions:
  - message: Deployment not started
    reason: NotRequested
    severity: Info
    status: "False"
    type: Ready
  - message: Deployment not started
    reason: NotRequested
    severity: Info
    status: "False"
    type: DeploymentReady
  - message: Input data complete
    reason: Ready
    status: "True"
    type: InputReady
  - message: Setup complete
    reason: Ready
    status: "True"
    type: SetupReady
---
apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlane
metadata:
  name: openstack-edpm-ipam
spec:
  deployStrategy:
    deploy: true
  nodeSets:
    - edpm-compute
status:
  conditions:
  - message: Deployment not started
    reason: NotRequested
    severity: Info
    status: "False"
    type: Ready
  - message: Deployment not started
    reason: NotRequested
    severity: Info
    status: "False"
    type: DeploymentReady
  - message: Setup complete
    reason: Ready
    status: "True"
    type: SetupReady
---
apiVersion: ansibleee.openstack.org/v1alpha1
kind: OpenStackAnsibleEE
metadata:
  name: dataplane-deployment-custom-image-service-edpm-compute-no-nodes
  namespace: openstack
  ownerReferences:
  - apiVersion: dataplane.openstack.org/v1beta1
    blockOwnerDeletion: true
    controller: true
    kind: OpenStackDataPlaneNodeSet
    name: openstack-edpm-ipam
spec:
  backoffLimit: 6
  extraMounts:
  - mounts:
    - mountPath: /runner/env/ssh_key
      name: ssh-key
      subPath: ssh_key
    - mountPath: /runner/inventory/hosts
      name: inventory
      subPath: inventory
    - mountPath: /runner/network/nic-config-template
      name: inventory
      subPath: network
    volumes:
    - name: ssh-key
      secret:
        items:
        - key: ssh-privatekey
          path: ssh_key
        secretName: dataplane-ansible-ssh-private-key-secret
    - name: inventory
      secret:
        items:
        - key: inventory
          path: inventory
        - key: network
          path: network
        secretName: dataplanerole-edpm-compute-no-nodes
  image: example.com/repo/runner-image:latest
  name: openstackansibleee
  restartPolicy: Never
  playbook: osp.edpm.test_playbook
  uid: 1001
status:
  JobStatus: Running
  conditions:
  - message: AnsibleExecutionJob is running
    reason: Requested
    severity: Info
    status: "False"
    type: Ready
  - message: AnsibleExecutionJob is running
    reason: Requested
    severity: Info
    status: "False"
    type: AnsibleExecutionJobReady
